<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DementiAid</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f5f5f5; }
        tr.clickable:hover { background: #eef; cursor: pointer; }
        tr.selected { background: #ddf; }
        .error { color: red; }
        .success { color: green; }
        form { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        form h2 { margin-top: 0; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, textarea { padding: 6px 10px; width: 100%; box-sizing: border-box; margin-top: 4px; }
        textarea { min-height: 80px; font-family: inherit; }
        button { margin-top: 16px; padding: 8px 20px; cursor: pointer; }
        .msg { margin-top: 10px; }
        .forms { display: flex; gap: 20px; }
        .forms > form { flex: 1; }
        section { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; }
    </style>
</head>
<body>
    <h1>Patients</h1>

    <div class="forms">
        <form id="add-patient-form">
            <h2>Add Patient</h2>
            <label>First Name <input type="text" name="first_name" required></label>
            <label>Last Name <input type="text" name="last_name" required></label>
            <label>Phone Number <input type="text" name="phone_num" placeholder="5551234567"></label>
            <label>Country Code <input type="text" name="country_code" placeholder="+1"></label>
            <label>Date of Birth <input type="date" name="date_of_birth"></label>
            <button type="submit">Add Patient</button>
            <div class="msg" id="add-message"></div>
        </form>

        <form id="update-patient-form">
            <h2>Update Patient</h2>
            <p style="margin:0;color:#666;">Click a row in the table to select a patient.</p>
            <input type="hidden" name="id" id="update-id">
            <label>First Name <input type="text" name="first_name" id="update-first_name"></label>
            <label>Last Name <input type="text" name="last_name" id="update-last_name"></label>
            <label>Phone Number <input type="text" name="phone_num" id="update-phone_num"></label>
            <label>Country Code <input type="text" name="country_code" id="update-country_code"></label>
            <label>Date of Birth <input type="date" name="date_of_birth" id="update-date_of_birth"></label>
            <button type="submit" id="update-btn" disabled>Update Patient</button>
            <div class="msg" id="update-message"></div>
        </form>
    </div>

    <div id="content">Loading...</div>

    <script>
        let allPatients = [];

        async function loadPatients() {
            let content = document.getElementById('content') || document.getElementById('patients-table');
            try {
                const res = await fetch('/patients');
                allPatients = await res.json();

                if (!allPatients.length) {
                    const div = document.createElement('div');
                    div.id = 'content';
                    div.textContent = 'No patients found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(allPatients[0]);
                const table = document.createElement('table');
                table.id = 'patients-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                allPatients.forEach(patient => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectPatient(patient));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = patient[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePatient(patient); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load patients: ' + err.message;
            }
        }

        function selectPatient(patient) {
            document.getElementById('update-id').value = patient.id;
            document.getElementById('update-first_name').value = patient.first_name ?? '';
            document.getElementById('update-last_name').value = patient.last_name ?? '';
            document.getElementById('update-phone_num').value = patient.phone_num ?? '';
            document.getElementById('update-country_code').value = patient.country_code ?? '';
            document.getElementById('update-date_of_birth').value = patient.date_of_birth ?? '';
            document.getElementById('update-btn').disabled = false;
            document.getElementById('update-message').textContent = 'Selected: ' + patient.first_name + ' ' + patient.last_name;
            document.getElementById('update-message').className = 'msg';

            document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
            const rows = document.querySelectorAll('#patients-table tbody tr');
            rows.forEach(row => {
                if (row.cells[0]?.textContent === patient.id) row.classList.add('selected');
            });
        }

        async function deletePatient(patient) {
            if (!confirm('Delete ' + patient.first_name + ' ' + patient.last_name + '?')) return;
            try {
                const res = await fetch('/patients/' + patient.id, { method: 'DELETE' });
                if (res.ok) {
                    loadPatients();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete patient');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('add-message');
            const form = e.target;
            const formData = new FormData(form);
            const patient = {};
            formData.forEach((value, key) => { if (value) patient[key] = value; });

            try {
                const res = await fetch('/patients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patient),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Patient added successfully';
                    form.reset();
                    loadPatients();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add patient';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('update-message');
            const id = document.getElementById('update-id').value;
            if (!id) { msg.className = 'msg error'; msg.textContent = 'No patient selected'; return; }

            const updates = {};
            ['first_name', 'last_name', 'phone_num', 'country_code', 'date_of_birth'].forEach(field => {
                const val = document.getElementById('update-' + field).value;
                updates[field] = val || null;
            });

            try {
                const res = await fetch('/patients/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Patient updated successfully';
                    loadPatients();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update patient';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadPatients();
    </script>

    <section>
        <h1>Journal Entries</h1>

        <div class="forms">
            <form id="add-journal-form">
                <h2>Add Journal Entry</h2>
                <label>Patient ID <input type="text" name="patient_id" required placeholder="patient uuid"></label>
                <label>Date <input type="date" name="date" required></label>
                <label>Content <textarea name="content" required></textarea></label>
                <button type="submit">Add Entry</button>
                <div class="msg" id="journal-add-message"></div>
            </form>

            <form id="update-journal-form">
                <h2>Update Journal Entry</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select an entry.</p>
                <input type="hidden" id="journal-update-patient_id">
                <input type="hidden" id="journal-update-date">
                <label>Content <textarea id="journal-update-content"></textarea></label>
                <button type="submit" id="journal-update-btn" disabled>Update Entry</button>
                <div class="msg" id="journal-update-message"></div>
            </form>
        </div>

        <div id="journal-content">Loading...</div>
    </section>

    <script>
        async function loadJournals() {
            let content = document.getElementById('journal-content') || document.getElementById('journal-table');
            try {
                const res = await fetch('/journal');
                const journals = await res.json();

                if (!journals.length) {
                    const div = document.createElement('div');
                    div.id = 'journal-content';
                    div.textContent = 'No journal entries found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(journals[0]);
                const table = document.createElement('table');
                table.id = 'journal-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                journals.forEach(entry => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectJournal(entry));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = entry[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteJournal(entry); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load journals: ' + err.message;
            }
        }

        function selectJournal(entry) {
            document.getElementById('journal-update-patient_id').value = entry.patient_id;
            document.getElementById('journal-update-date').value = entry.date;
            document.getElementById('journal-update-content').value = entry.content ?? '';
            document.getElementById('journal-update-btn').disabled = false;
            const msg = document.getElementById('journal-update-message');
            msg.className = 'msg';
            msg.textContent = 'Selected: ' + entry.patient_id + ' / ' + entry.date;
        }

        async function deleteJournal(entry) {
            if (!confirm('Delete journal entry for ' + entry.date + '?')) return;
            try {
                const res = await fetch('/journal/' + entry.patient_id + '/' + entry.date, { method: 'DELETE' });
                if (res.ok) {
                    loadJournals();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete journal entry');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('journal-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const entry = {};
            formData.forEach((value, key) => { if (value) entry[key] = value; });

            try {
                const res = await fetch('/journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Journal entry added successfully';
                    form.reset();
                    loadJournals();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add journal entry';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('journal-update-message');
            const patientId = document.getElementById('journal-update-patient_id').value;
            const date = document.getElementById('journal-update-date').value;
            if (!patientId || !date) { msg.className = 'msg error'; msg.textContent = 'No entry selected'; return; }

            const updates = { content: document.getElementById('journal-update-content').value || null };

            try {
                const res = await fetch('/journal/' + patientId + '/' + date, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Journal entry updated successfully';
                    loadJournals();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update journal entry';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadJournals();
    </script>

    <section>
        <h1>Reminder Settings</h1>

        <div class="forms">
            <form id="add-reminder-form">
                <h2>Add Reminder</h2>
                <label>Patient ID <input type="text" name="patient_id" required placeholder="patient uuid"></label>
                <label>Provider ID <input type="text" name="provider_id" required placeholder="provider uuid"></label>
                <label>Frequency <input type="text" name="frequency" required placeholder="e.g. daily, weekly"></label>
                <label>Content <textarea name="content" required></textarea></label>
                <button type="submit">Add Reminder</button>
                <div class="msg" id="reminder-add-message"></div>
            </form>

            <form id="update-reminder-form">
                <h2>Update Reminder</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select a reminder.</p>
                <input type="hidden" id="reminder-update-id">
                <label>Patient ID <input type="text" id="reminder-update-patient_id"></label>
                <label>Provider ID <input type="text" id="reminder-update-provider_id"></label>
                <label>Frequency <input type="text" id="reminder-update-frequency"></label>
                <label>Content <textarea id="reminder-update-content"></textarea></label>
                <button type="submit" id="reminder-update-btn" disabled>Update Reminder</button>
                <div class="msg" id="reminder-update-message"></div>
            </form>
        </div>

        <div id="reminder-content">Loading...</div>
    </section>

    <script>
        async function loadReminders() {
            let content = document.getElementById('reminder-content') || document.getElementById('reminder-table');
            try {
                const res = await fetch('/reminders');
                const reminders = await res.json();

                if (!reminders.length) {
                    const div = document.createElement('div');
                    div.id = 'reminder-content';
                    div.textContent = 'No reminder settings found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(reminders[0]);
                const table = document.createElement('table');
                table.id = 'reminder-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                reminders.forEach(reminder => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectReminder(reminder));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = reminder[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteReminder(reminder); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load reminders: ' + err.message;
            }
        }

        function selectReminder(reminder) {
            document.getElementById('reminder-update-id').value = reminder.id;
            document.getElementById('reminder-update-patient_id').value = reminder.patient_id ?? '';
            document.getElementById('reminder-update-provider_id').value = reminder.provider_id ?? '';
            document.getElementById('reminder-update-frequency').value = reminder.frequency ?? '';
            document.getElementById('reminder-update-content').value = reminder.content ?? '';
            document.getElementById('reminder-update-btn').disabled = false;
            const msg = document.getElementById('reminder-update-message');
            msg.className = 'msg';
            msg.textContent = 'Selected reminder #' + reminder.id;
        }

        async function deleteReminder(reminder) {
            if (!confirm('Delete reminder #' + reminder.id + '?')) return;
            try {
                const res = await fetch('/reminders/' + reminder.id, { method: 'DELETE' });
                if (res.ok) {
                    loadReminders();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete reminder');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('reminder-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const reminder = {};
            formData.forEach((value, key) => { if (value) reminder[key] = value; });

            try {
                const res = await fetch('/reminders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reminder),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Reminder added successfully';
                    form.reset();
                    loadReminders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add reminder';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('reminder-update-message');
            const id = document.getElementById('reminder-update-id').value;
            if (!id) { msg.className = 'msg error'; msg.textContent = 'No reminder selected'; return; }

            const updates = {};
            ['patient_id', 'provider_id', 'frequency', 'content'].forEach(field => {
                const val = document.getElementById('reminder-update-' + field).value;
                updates[field] = val || null;
            });

            try {
                const res = await fetch('/reminders/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Reminder updated successfully';
                    loadReminders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update reminder';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadReminders();
    </script>
</body>
</html>
