<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DementiAid</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f5f5f5; }
        tr.clickable:hover { background: #eef; cursor: pointer; }
        tr.selected { background: #ddf; }
        .error { color: red; }
        .success { color: green; }
        form { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        form h2 { margin-top: 0; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, textarea { padding: 6px 10px; width: 100%; box-sizing: border-box; margin-top: 4px; }
        textarea { min-height: 80px; font-family: inherit; }
        button { margin-top: 16px; padding: 8px 20px; cursor: pointer; }
        .msg { margin-top: 10px; }
        .forms { display: flex; gap: 20px; }
        .forms > form { flex: 1; }
        section { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; }
    </style>
</head>
<body>
    <h1>Patients</h1>

    <div class="forms">
        <form id="add-patient-form">
            <h2>Add Patient</h2>
            <label>First Name <input type="text" name="first_name" required></label>
            <label>Last Name <input type="text" name="last_name" required></label>
            <label>Phone Number <input type="text" name="phone_num" placeholder="5551234567"></label>
            <label>Country Code <input type="text" name="country_code" placeholder="+1"></label>
            <label>Date of Birth <input type="date" name="date_of_birth"></label>
            <button type="submit">Add Patient</button>
            <div class="msg" id="add-message"></div>
        </form>

        <form id="update-patient-form">
            <h2>Update Patient</h2>
            <p style="margin:0;color:#666;">Click a row in the table to select a patient.</p>
            <input type="hidden" name="id" id="update-id">
            <label>First Name <input type="text" name="first_name" id="update-first_name"></label>
            <label>Last Name <input type="text" name="last_name" id="update-last_name"></label>
            <label>Phone Number <input type="text" name="phone_num" id="update-phone_num"></label>
            <label>Country Code <input type="text" name="country_code" id="update-country_code"></label>
            <label>Date of Birth <input type="date" name="date_of_birth" id="update-date_of_birth"></label>
            <button type="submit" id="update-btn" disabled>Update Patient</button>
            <div class="msg" id="update-message"></div>
        </form>
    </div>

    <div id="content">Loading...</div>

    <script>
        let allPatients = [];

        async function loadPatients() {
            let content = document.getElementById('content') || document.getElementById('patients-table');
            try {
                const res = await fetch('/patients');
                allPatients = await res.json();

                if (!allPatients.length) {
                    const div = document.createElement('div');
                    div.id = 'content';
                    div.textContent = 'No patients found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(allPatients[0]);
                const table = document.createElement('table');
                table.id = 'patients-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                allPatients.forEach(patient => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectPatient(patient));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = patient[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePatient(patient); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load patients: ' + err.message;
            }
        }

        function selectPatient(patient) {
            document.getElementById('update-id').value = patient.id;
            document.getElementById('update-first_name').value = patient.first_name ?? '';
            document.getElementById('update-last_name').value = patient.last_name ?? '';
            document.getElementById('update-phone_num').value = patient.phone_num ?? '';
            document.getElementById('update-country_code').value = patient.country_code ?? '';
            document.getElementById('update-date_of_birth').value = patient.date_of_birth ?? '';
            document.getElementById('update-btn').disabled = false;
            document.getElementById('update-message').textContent = 'Selected: ' + patient.first_name + ' ' + patient.last_name;
            document.getElementById('update-message').className = 'msg';

            document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
            const rows = document.querySelectorAll('#patients-table tbody tr');
            rows.forEach(row => {
                if (row.cells[0]?.textContent === patient.id) row.classList.add('selected');
            });
        }

        async function deletePatient(patient) {
            if (!confirm('Delete ' + patient.first_name + ' ' + patient.last_name + '?')) return;
            try {
                const res = await fetch('/patients/' + patient.id, { method: 'DELETE' });
                if (res.ok) {
                    loadPatients();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete patient');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('add-message');
            const form = e.target;
            const formData = new FormData(form);
            const patient = {};
            formData.forEach((value, key) => { if (value) patient[key] = value; });

            try {
                const res = await fetch('/patients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patient),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Patient added successfully';
                    form.reset();
                    loadPatients();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add patient';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('update-message');
            const id = document.getElementById('update-id').value;
            if (!id) { msg.className = 'msg error'; msg.textContent = 'No patient selected'; return; }

            const updates = {};
            ['first_name', 'last_name', 'phone_num', 'country_code', 'date_of_birth'].forEach(field => {
                const val = document.getElementById('update-' + field).value;
                updates[field] = val || null;
            });

            try {
                const res = await fetch('/patients/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Patient updated successfully';
                    loadPatients();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update patient';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadPatients();
    </script>

    <section>
        <h1>Journal Entries</h1>

        <div class="forms">
            <form id="add-journal-form">
                <h2>Add Journal Entry</h2>
                <label>Patient ID <input type="text" name="patient_id" required placeholder="patient uuid"></label>
                <label>Date <input type="date" name="date" required></label>
                <label>Content <textarea name="content" required></textarea></label>
                <button type="submit">Add Entry</button>
                <div class="msg" id="journal-add-message"></div>
            </form>

            <form id="update-journal-form">
                <h2>Update Journal Entry</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select an entry.</p>
                <input type="hidden" id="journal-update-patient_id">
                <input type="hidden" id="journal-update-date">
                <label>Content <textarea id="journal-update-content"></textarea></label>
                <button type="submit" id="journal-update-btn" disabled>Update Entry</button>
                <div class="msg" id="journal-update-message"></div>
            </form>
        </div>

        <div id="journal-content">Loading...</div>
    </section>

    <script>
        async function loadJournals() {
            let content = document.getElementById('journal-content') || document.getElementById('journal-table');
            try {
                const res = await fetch('/journal');
                const journals = await res.json();

                if (!journals.length) {
                    const div = document.createElement('div');
                    div.id = 'journal-content';
                    div.textContent = 'No journal entries found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(journals[0]);
                const table = document.createElement('table');
                table.id = 'journal-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                journals.forEach(entry => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectJournal(entry));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = entry[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteJournal(entry); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load journals: ' + err.message;
            }
        }

        function selectJournal(entry) {
            document.getElementById('journal-update-patient_id').value = entry.patient_id;
            document.getElementById('journal-update-date').value = entry.date;
            document.getElementById('journal-update-content').value = entry.content ?? '';
            document.getElementById('journal-update-btn').disabled = false;
            const msg = document.getElementById('journal-update-message');
            msg.className = 'msg';
            msg.textContent = 'Selected: ' + entry.patient_id + ' / ' + entry.date;
        }

        async function deleteJournal(entry) {
            if (!confirm('Delete journal entry for ' + entry.date + '?')) return;
            try {
                const res = await fetch('/journal/' + entry.patient_id + '/' + entry.date, { method: 'DELETE' });
                if (res.ok) {
                    loadJournals();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete journal entry');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('journal-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const entry = {};
            formData.forEach((value, key) => { if (value) entry[key] = value; });

            try {
                const res = await fetch('/journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Journal entry added successfully';
                    form.reset();
                    loadJournals();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add journal entry';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('journal-update-message');
            const patientId = document.getElementById('journal-update-patient_id').value;
            const date = document.getElementById('journal-update-date').value;
            if (!patientId || !date) { msg.className = 'msg error'; msg.textContent = 'No entry selected'; return; }

            const updates = { content: document.getElementById('journal-update-content').value || null };

            try {
                const res = await fetch('/journal/' + patientId + '/' + date, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Journal entry updated successfully';
                    loadJournals();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update journal entry';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadJournals();
    </script>

    <section>
        <h1>Reminder Settings</h1>

        <div class="forms">
            <form id="add-reminder-form">
                <h2>Add Reminder</h2>
                <label>Patient ID <input type="text" name="patient_id" required placeholder="patient uuid"></label>
                <label>Provider ID <input type="text" name="provider_id" required placeholder="provider uuid"></label>
                <label>Frequency <input type="text" name="frequency" required placeholder="e.g. daily, weekly"></label>
                <label>Content <textarea name="content" required></textarea></label>
                <button type="submit">Add Reminder</button>
                <div class="msg" id="reminder-add-message"></div>
            </form>

            <form id="update-reminder-form">
                <h2>Update Reminder</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select a reminder.</p>
                <input type="hidden" id="reminder-update-id">
                <label>Patient ID <input type="text" id="reminder-update-patient_id"></label>
                <label>Provider ID <input type="text" id="reminder-update-provider_id"></label>
                <label>Frequency <input type="text" id="reminder-update-frequency"></label>
                <label>Content <textarea id="reminder-update-content"></textarea></label>
                <button type="submit" id="reminder-update-btn" disabled>Update Reminder</button>
                <div class="msg" id="reminder-update-message"></div>
            </form>
        </div>

        <div id="reminder-content">Loading...</div>
    </section>

    <script>
        async function loadReminders() {
            let content = document.getElementById('reminder-content') || document.getElementById('reminder-table');
            try {
                const res = await fetch('/reminders');
                const reminders = await res.json();

                if (!reminders.length) {
                    const div = document.createElement('div');
                    div.id = 'reminder-content';
                    div.textContent = 'No reminder settings found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(reminders[0]);
                const table = document.createElement('table');
                table.id = 'reminder-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                reminders.forEach(reminder => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectReminder(reminder));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = reminder[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteReminder(reminder); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load reminders: ' + err.message;
            }
        }

        function selectReminder(reminder) {
            document.getElementById('reminder-update-id').value = reminder.id;
            document.getElementById('reminder-update-patient_id').value = reminder.patient_id ?? '';
            document.getElementById('reminder-update-provider_id').value = reminder.provider_id ?? '';
            document.getElementById('reminder-update-frequency').value = reminder.frequency ?? '';
            document.getElementById('reminder-update-content').value = reminder.content ?? '';
            document.getElementById('reminder-update-btn').disabled = false;
            const msg = document.getElementById('reminder-update-message');
            msg.className = 'msg';
            msg.textContent = 'Selected reminder #' + reminder.id;
        }

        async function deleteReminder(reminder) {
            if (!confirm('Delete reminder #' + reminder.id + '?')) return;
            try {
                const res = await fetch('/reminders/' + reminder.id, { method: 'DELETE' });
                if (res.ok) {
                    loadReminders();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete reminder');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('reminder-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const reminder = {};
            formData.forEach((value, key) => { if (value) reminder[key] = value; });

            try {
                const res = await fetch('/reminders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reminder),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Reminder added successfully';
                    form.reset();
                    loadReminders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add reminder';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('reminder-update-message');
            const id = document.getElementById('reminder-update-id').value;
            if (!id) { msg.className = 'msg error'; msg.textContent = 'No reminder selected'; return; }

            const updates = {};
            ['patient_id', 'provider_id', 'frequency', 'content'].forEach(field => {
                const val = document.getElementById('reminder-update-' + field).value;
                updates[field] = val || null;
            });

            try {
                const res = await fetch('/reminders/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Reminder updated successfully';
                    loadReminders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update reminder';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadReminders();
    </script>

    <section>
        <h1>Providers</h1>

        <div class="forms">
            <form id="add-provider-form">
                <h2>Add Provider</h2>
                <label>User ID (auth.users.id) <input type="text" name="id" required placeholder="uuid from auth.users"></label>
                <label>First Name <input type="text" name="first_name" required></label>
                <label>Last Name <input type="text" name="last_name" required></label>
                <label>Email <input type="email" name="email"></label>
                <button type="submit">Add Provider</button>
                <div class="msg" id="provider-add-message"></div>
            </form>

            <form id="update-provider-form">
                <h2>Update Provider</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select a provider.</p>
                <input type="hidden" id="provider-update-id">
                <label>First Name <input type="text" id="provider-update-first_name"></label>
                <label>Last Name <input type="text" id="provider-update-last_name"></label>
                <label>Email <input type="email" id="provider-update-email"></label>
                <button type="submit" id="provider-update-btn" disabled>Update Provider</button>
                <div class="msg" id="provider-update-message"></div>
            </form>
        </div>

        <div id="provider-content">Loading...</div>
    </section>

    <script>
        async function loadProviders() {
            let content = document.getElementById('provider-content') || document.getElementById('provider-table');
            try {
                const res = await fetch('/providers');
                const providers = await res.json();

                if (!providers.length) {
                    const div = document.createElement('div');
                    div.id = 'provider-content';
                    div.textContent = 'No providers found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(providers[0]);
                const table = document.createElement('table');
                table.id = 'provider-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                providers.forEach(provider => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectProvider(provider));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = provider[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteProvider(provider); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load providers: ' + err.message;
            }
        }

        function selectProvider(provider) {
            document.getElementById('provider-update-id').value = provider.id;
            document.getElementById('provider-update-first_name').value = provider.first_name ?? '';
            document.getElementById('provider-update-last_name').value = provider.last_name ?? '';
            document.getElementById('provider-update-email').value = provider.email ?? '';
            document.getElementById('provider-update-btn').disabled = false;
            const msg = document.getElementById('provider-update-message');
            msg.className = 'msg';
            msg.textContent = 'Selected: ' + provider.first_name + ' ' + provider.last_name;
        }

        async function deleteProvider(provider) {
            if (!confirm('Delete ' + provider.first_name + ' ' + provider.last_name + '?')) return;
            try {
                const res = await fetch('/providers/' + provider.id, { method: 'DELETE' });
                if (res.ok) {
                    loadProviders();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete provider');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-provider-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('provider-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const provider = {};
            formData.forEach((value, key) => { if (value) provider[key] = value; });

            try {
                const res = await fetch('/providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(provider),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Provider added successfully';
                    form.reset();
                    loadProviders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add provider';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-provider-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('provider-update-message');
            const id = document.getElementById('provider-update-id').value;
            if (!id) { msg.className = 'msg error'; msg.textContent = 'No provider selected'; return; }

            const updates = {};
            ['first_name', 'last_name', 'email'].forEach(field => {
                const val = document.getElementById('provider-update-' + field).value;
                updates[field] = val || null;
            });

            try {
                const res = await fetch('/providers/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Provider updated successfully';
                    loadProviders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update provider';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadProviders();
    </script>

    <section>
        <h1>Patient-Provider Relations</h1>

        <div class="forms">
            <form id="add-pp-form">
                <h2>Add Relation</h2>
                <label>Patient ID <input type="text" name="patient_id" required placeholder="patient uuid"></label>
                <label>Provider ID <input type="text" name="provider_id" required placeholder="provider uuid"></label>
                <label>Patient Authorized
                    <select name="patient_authorized" style="padding:6px 10px;width:100%;box-sizing:border-box;margin-top:4px;">
                        <option value="true">Yes</option>
                        <option value="false" selected>No</option>
                    </select>
                </label>
                <button type="submit">Add Relation</button>
                <div class="msg" id="pp-add-message"></div>
            </form>

            <form id="update-pp-form">
                <h2>Update Relation</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select a relation.</p>
                <input type="hidden" id="pp-update-patient_id">
                <input type="hidden" id="pp-update-provider_id">
                <label>Patient Authorized
                    <select id="pp-update-patient_authorized" style="padding:6px 10px;width:100%;box-sizing:border-box;margin-top:4px;">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </label>
                <button type="submit" id="pp-update-btn" disabled>Update Relation</button>
                <div class="msg" id="pp-update-message"></div>
            </form>
        </div>

        <div id="pp-content">Loading...</div>
    </section>

    <script>
        async function loadPatientProviders() {
            let content = document.getElementById('pp-content') || document.getElementById('pp-table');
            try {
                const res = await fetch('/patients-providers');
                const relations = await res.json();

                if (!relations.length) {
                    const div = document.createElement('div');
                    div.id = 'pp-content';
                    div.textContent = 'No patient-provider relations found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(relations[0]);
                const table = document.createElement('table');
                table.id = 'pp-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                relations.forEach(relation => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectPatientProvider(relation));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = relation[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePatientProvider(relation); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load patient-provider relations: ' + err.message;
            }
        }

        function selectPatientProvider(relation) {
            document.getElementById('pp-update-patient_id').value = relation.patient_id;
            document.getElementById('pp-update-provider_id').value = relation.provider_id;
            document.getElementById('pp-update-patient_authorized').value = String(relation.patient_authorized);
            document.getElementById('pp-update-btn').disabled = false;
            const msg = document.getElementById('pp-update-message');
            msg.className = 'msg';
            msg.textContent = 'Selected: ' + relation.patient_id + ' / ' + relation.provider_id;
        }

        async function deletePatientProvider(relation) {
            if (!confirm('Delete relation between patient ' + relation.patient_id + ' and provider ' + relation.provider_id + '?')) return;
            try {
                const res = await fetch('/patients-providers/' + relation.patient_id + '/' + relation.provider_id, { method: 'DELETE' });
                if (res.ok) {
                    loadPatientProviders();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete relation');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-pp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('pp-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const relation = {};
            formData.forEach((value, key) => {
                if (key === 'patient_authorized') {
                    relation[key] = value === 'true';
                } else if (value) {
                    relation[key] = value;
                }
            });

            try {
                const res = await fetch('/patients-providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(relation),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Relation added successfully';
                    form.reset();
                    loadPatientProviders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add relation';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-pp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('pp-update-message');
            const patientId = document.getElementById('pp-update-patient_id').value;
            const providerId = document.getElementById('pp-update-provider_id').value;
            if (!patientId || !providerId) { msg.className = 'msg error'; msg.textContent = 'No relation selected'; return; }

            const updates = {
                patient_authorized: document.getElementById('pp-update-patient_authorized').value === 'true'
            };

            try {
                const res = await fetch('/patients-providers/' + patientId + '/' + providerId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Relation updated successfully';
                    loadPatientProviders();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update relation';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadPatientProviders();
    </script>

    <section>
        <h1>Chatbot Messages</h1>

        <div class="forms">
            <form id="add-chatmsg-form">
                <h2>Add Message</h2>
                <label>Patient ID <input type="text" name="patient_id" required placeholder="patient uuid"></label>
                <label>Sender <input type="text" name="sender" required placeholder="e.g. patient or bot"></label>
                <label>Content <textarea name="content" placeholder="message content"></textarea></label>
                <button type="submit">Add Message</button>
                <div class="msg" id="chatmsg-add-message"></div>
            </form>

            <form id="update-chatmsg-form">
                <h2>Update Message</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select a message.</p>
                <input type="hidden" id="chatmsg-update-id">
                <label>Patient ID <input type="text" id="chatmsg-update-patient_id"></label>
                <label>Sender <input type="text" id="chatmsg-update-sender"></label>
                <label>Content <textarea id="chatmsg-update-content"></textarea></label>
                <button type="submit" id="chatmsg-update-btn" disabled>Update Message</button>
                <div class="msg" id="chatmsg-update-message"></div>
            </form>
        </div>

        <div id="chatmsg-content">Loading...</div>
    </section>

    <script>
        async function loadChatbotMessages() {
            let content = document.getElementById('chatmsg-content') || document.getElementById('chatmsg-table');
            try {
                const res = await fetch('/chatbot-messages');
                const messages = await res.json();

                if (!messages.length) {
                    const div = document.createElement('div');
                    div.id = 'chatmsg-content';
                    div.textContent = 'No chatbot messages found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(messages[0]);
                const table = document.createElement('table');
                table.id = 'chatmsg-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                messages.forEach(msg => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectChatbotMessage(msg));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = msg[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteChatbotMessage(msg); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load chatbot messages: ' + err.message;
            }
        }

        function selectChatbotMessage(msg) {
            document.getElementById('chatmsg-update-id').value = msg.id;
            document.getElementById('chatmsg-update-patient_id').value = msg.patient_id || '';
            document.getElementById('chatmsg-update-sender').value = msg.sender || '';
            document.getElementById('chatmsg-update-content').value = msg.content || '';
            document.getElementById('chatmsg-update-btn').disabled = false;
            const msgEl = document.getElementById('chatmsg-update-message');
            msgEl.className = 'msg';
            msgEl.textContent = 'Selected message #' + msg.id;
        }

        async function deleteChatbotMessage(msg) {
            if (!confirm('Delete chatbot message #' + msg.id + '?')) return;
            try {
                const res = await fetch('/chatbot-messages/' + msg.id, { method: 'DELETE' });
                if (res.ok) {
                    loadChatbotMessages();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete message');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-chatmsg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('chatmsg-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const message = {};
            formData.forEach((value, key) => { if (value) message[key] = value; });

            try {
                const res = await fetch('/chatbot-messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(message),
                });
                if (res.ok) {
                    msgEl.className = 'msg success';
                    msgEl.textContent = 'Message added successfully';
                    form.reset();
                    loadChatbotMessages();
                } else {
                    const err = await res.json();
                    msgEl.className = 'msg error';
                    msgEl.textContent = err.error || 'Failed to add message';
                }
            } catch (err) {
                msgEl.className = 'msg error';
                msgEl.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-chatmsg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('chatmsg-update-message');
            const id = document.getElementById('chatmsg-update-id').value;
            if (!id) { msgEl.className = 'msg error'; msgEl.textContent = 'No message selected'; return; }

            const updates = {};
            const patientId = document.getElementById('chatmsg-update-patient_id').value;
            const sender = document.getElementById('chatmsg-update-sender').value;
            const content = document.getElementById('chatmsg-update-content').value;
            if (patientId) updates.patient_id = patientId;
            if (sender) updates.sender = sender;
            if (content) updates.content = content;

            try {
                const res = await fetch('/chatbot-messages/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msgEl.className = 'msg success';
                    msgEl.textContent = 'Message updated successfully';
                    loadChatbotMessages();
                } else {
                    const err = await res.json();
                    msgEl.className = 'msg error';
                    msgEl.textContent = err.error || 'Failed to update message';
                }
            } catch (err) {
                msgEl.className = 'msg error';
                msgEl.textContent = 'Request failed: ' + err.message;
            }
        });

        loadChatbotMessages();
    </script>

    <section>
        <h1>Messages</h1>

        <div class="forms">
            <form id="add-msg-form">
                <h2>Add Message</h2>
                <label>Reminder ID <input type="number" name="reminder_id" required placeholder="reminder_settings id"></label>
                <button type="submit">Add Message</button>
                <div class="msg" id="msg-add-message"></div>
            </form>

            <form id="update-msg-form">
                <h2>Update Message</h2>
                <p style="margin:0;color:#666;">Click a row in the table to select a message.</p>
                <input type="hidden" id="msg-update-id">
                <label>Reminder ID <input type="number" id="msg-update-reminder_id"></label>
                <button type="submit" id="msg-update-btn" disabled>Update Message</button>
                <div class="msg" id="msg-update-message"></div>
            </form>
        </div>

        <div id="msg-content">Loading...</div>
    </section>

    <script>
        async function loadMessages() {
            let content = document.getElementById('msg-content') || document.getElementById('msg-table');
            try {
                const res = await fetch('/messages');
                const messages = await res.json();

                if (!messages.length) {
                    const div = document.createElement('div');
                    div.id = 'msg-content';
                    div.textContent = 'No messages found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(messages[0]);
                const table = document.createElement('table');
                table.id = 'msg-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                messages.forEach(m => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectMessage(m));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = m[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteMessageRow(m); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load messages: ' + err.message;
            }
        }

        function selectMessage(m) {
            document.getElementById('msg-update-id').value = m.id;
            document.getElementById('msg-update-reminder_id').value = m.reminder_id || '';
            document.getElementById('msg-update-btn').disabled = false;
            const msgEl = document.getElementById('msg-update-message');
            msgEl.className = 'msg';
            msgEl.textContent = 'Selected message #' + m.id;
        }

        async function deleteMessageRow(m) {
            if (!confirm('Delete message #' + m.id + '?')) return;
            try {
                const res = await fetch('/messages/' + m.id, { method: 'DELETE' });
                if (res.ok) {
                    loadMessages();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete message');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-msg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('msg-add-message');
            const form = e.target;
            const formData = new FormData(form);
            const message = {};
            formData.forEach((value, key) => { if (value) message[key] = value; });

            try {
                const res = await fetch('/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(message),
                });
                if (res.ok) {
                    msgEl.className = 'msg success';
                    msgEl.textContent = 'Message added successfully';
                    form.reset();
                    loadMessages();
                } else {
                    const err = await res.json();
                    msgEl.className = 'msg error';
                    msgEl.textContent = err.error || 'Failed to add message';
                }
            } catch (err) {
                msgEl.className = 'msg error';
                msgEl.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-msg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msgEl = document.getElementById('msg-update-message');
            const id = document.getElementById('msg-update-id').value;
            if (!id) { msgEl.className = 'msg error'; msgEl.textContent = 'No message selected'; return; }

            const updates = {};
            const reminderId = document.getElementById('msg-update-reminder_id').value;
            if (reminderId) updates.reminder_id = reminderId;

            try {
                const res = await fetch('/messages/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msgEl.className = 'msg success';
                    msgEl.textContent = 'Message updated successfully';
                    loadMessages();
                } else {
                    const err = await res.json();
                    msgEl.className = 'msg error';
                    msgEl.textContent = err.error || 'Failed to update message';
                }
            } catch (err) {
                msgEl.className = 'msg error';
                msgEl.textContent = 'Request failed: ' + err.message;
            }
        });

        loadMessages();
    </script>
</body>
</html>
