<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DementiAid - Patients</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f5f5f5; }
        tr.clickable:hover { background: #eef; cursor: pointer; }
        tr.selected { background: #ddf; }
        .error { color: red; }
        .success { color: green; }
        form { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        form h2 { margin-top: 0; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input { padding: 6px 10px; width: 100%; box-sizing: border-box; margin-top: 4px; }
        button { margin-top: 16px; padding: 8px 20px; cursor: pointer; }
        .msg { margin-top: 10px; }
        .forms { display: flex; gap: 20px; }
        .forms > form { flex: 1; }
    </style>
</head>
<body>
    <h1>Patients</h1>

    <div class="forms">
        <form id="add-patient-form">
            <h2>Add Patient</h2>
            <label>First Name <input type="text" name="first_name" required></label>
            <label>Last Name <input type="text" name="last_name" required></label>
            <label>Phone Number <input type="text" name="phone_num" placeholder="5551234567"></label>
            <label>Country Code <input type="text" name="country_code" placeholder="+1"></label>
            <label>Date of Birth <input type="date" name="date_of_birth"></label>
            <button type="submit">Add Patient</button>
            <div class="msg" id="add-message"></div>
        </form>

        <form id="update-patient-form">
            <h2>Update Patient</h2>
            <p style="margin:0;color:#666;">Click a row in the table to select a patient.</p>
            <input type="hidden" name="id" id="update-id">
            <label>First Name <input type="text" name="first_name" id="update-first_name"></label>
            <label>Last Name <input type="text" name="last_name" id="update-last_name"></label>
            <label>Phone Number <input type="text" name="phone_num" id="update-phone_num"></label>
            <label>Country Code <input type="text" name="country_code" id="update-country_code"></label>
            <label>Date of Birth <input type="date" name="date_of_birth" id="update-date_of_birth"></label>
            <button type="submit" id="update-btn" disabled>Update Patient</button>
            <div class="msg" id="update-message"></div>
        </form>
    </div>

    <div id="content">Loading...</div>

    <script>
        let allPatients = [];

        async function loadPatients() {
            let content = document.getElementById('content') || document.getElementById('patients-table');
            try {
                const res = await fetch('/patients');
                allPatients = await res.json();

                if (!allPatients.length) {
                    const div = document.createElement('div');
                    div.id = 'content';
                    div.textContent = 'No patients found.';
                    content.replaceWith(div);
                    return;
                }

                const columns = Object.keys(allPatients[0]);
                const table = document.createElement('table');
                table.id = 'patients-table';

                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                const actionTh = document.createElement('th');
                actionTh.textContent = 'Actions';
                headerRow.appendChild(actionTh);

                const tbody = table.createTBody();
                allPatients.forEach(patient => {
                    const row = tbody.insertRow();
                    row.className = 'clickable';
                    row.addEventListener('click', () => selectPatient(patient));
                    columns.forEach(col => {
                        const td = row.insertCell();
                        td.textContent = patient[col] ?? '';
                    });
                    const actionTd = row.insertCell();
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.cssText = 'margin:0;padding:4px 12px;color:red;border:1px solid red;background:white;cursor:pointer;';
                    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePatient(patient); });
                    actionTd.appendChild(delBtn);
                });

                content.replaceWith(table);
            } catch (err) {
                content.className = 'error';
                content.textContent = 'Failed to load patients: ' + err.message;
            }
        }

        function selectPatient(patient) {
            document.getElementById('update-id').value = patient.id;
            document.getElementById('update-first_name').value = patient.first_name ?? '';
            document.getElementById('update-last_name').value = patient.last_name ?? '';
            document.getElementById('update-phone_num').value = patient.phone_num ?? '';
            document.getElementById('update-country_code').value = patient.country_code ?? '';
            document.getElementById('update-date_of_birth').value = patient.date_of_birth ?? '';
            document.getElementById('update-btn').disabled = false;
            document.getElementById('update-message').textContent = 'Selected: ' + patient.first_name + ' ' + patient.last_name;
            document.getElementById('update-message').className = 'msg';

            document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
            const rows = document.querySelectorAll('#patients-table tbody tr');
            rows.forEach(row => {
                if (row.cells[0]?.textContent === patient.id) row.classList.add('selected');
            });
        }

        async function deletePatient(patient) {
            if (!confirm('Delete ' + patient.first_name + ' ' + patient.last_name + '?')) return;
            try {
                const res = await fetch('/patients/' + patient.id, { method: 'DELETE' });
                if (res.ok) {
                    loadPatients();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to delete patient');
                }
            } catch (err) {
                alert('Request failed: ' + err.message);
            }
        }

        document.getElementById('add-patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('add-message');
            const form = e.target;
            const formData = new FormData(form);
            const patient = {};
            formData.forEach((value, key) => { if (value) patient[key] = value; });

            try {
                const res = await fetch('/patients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patient),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Patient added successfully';
                    form.reset();
                    loadPatients();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to add patient';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        document.getElementById('update-patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('update-message');
            const id = document.getElementById('update-id').value;
            if (!id) { msg.className = 'msg error'; msg.textContent = 'No patient selected'; return; }

            const updates = {};
            ['first_name', 'last_name', 'phone_num', 'country_code', 'date_of_birth'].forEach(field => {
                const val = document.getElementById('update-' + field).value;
                updates[field] = val || null;
            });

            try {
                const res = await fetch('/patients/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                if (res.ok) {
                    msg.className = 'msg success';
                    msg.textContent = 'Patient updated successfully';
                    loadPatients();
                } else {
                    const err = await res.json();
                    msg.className = 'msg error';
                    msg.textContent = err.error || 'Failed to update patient';
                }
            } catch (err) {
                msg.className = 'msg error';
                msg.textContent = 'Request failed: ' + err.message;
            }
        });

        loadPatients();
    </script>
</body>
</html>
